<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>12 STEM 2C - FUND TRACKER</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Custom styles to enhance the visual appeal and responsiveness */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5; /* Light gray background */
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Align content to the top */
            padding: 20px;
        }
        .container {
            background-color: #ffffff; /* White container background */
            border-radius: 12px; /* Rounded corners for the container */
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1); /* Soft shadow */
            padding: 30px;
            width: 100%;
            max-width: 1200px; /* Maximum width for the container */
            overflow-x: auto; /* Enable horizontal scrolling for narrow screens */
        }
        table {
            width: 100%;
            border-collapse: separate; /* Allows for border-spacing */
            border-spacing: 0;
            margin-top: 20px;
            min-width: 700px; /* Ensures the table is wide enough for content */
            table-layout: fixed; /* THIS IS KEY FOR FIXED COLUMN WIDTHS */
        }
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb; /* Light gray border for table rows */
            vertical-align: middle; /* Ensure content is vertically centered in cells */
            word-wrap: break-word; /* Allow long words to break and wrap */
            overflow-wrap: break-word; /* Standard property for word wrapping */
        }
        th {
            background-color: #edf2f7; /* Light blue-gray for table headers */
            font-weight: 600; /* Semi-bold font */
            color: #4a5568; /* Dark gray text color */
            position: sticky; /* Make header sticky when scrolling */
            top: 0;
            z-index: 10; /* Ensure header stays on top */
        }
        /* Explicit column widths for fixed table layout (main table) */
        th:nth-child(1) { width: 30%; } /* Student Name - adjust as needed */
        th:nth-child(2) { width: 40%; } /* Payment Date - adjust as needed, needs more space */
        th:nth-child(3) { width: 30%; } /* Status - adjust as needed */


        tr:hover {
            background-color: #f9fafb; /* Light hover effect for table rows */
        }
        select {
            padding: 8px;
            border-radius: 8px; /* Rounded corners for select dropdowns */
            border: 1px solid #d1d5db; /* Light gray border */
            background-color: #ffffff;
            font-size: 0.9rem;
            min-width: 140px; /* Minimum width for dropdowns */
            cursor: pointer;
            outline: none; /* Remove outline on focus */
            transition: border-color 0.2s; /* Smooth transition for border */
        }
        select:focus {
            border-color: #4c51bf; /* Blue border on focus */
        }
        input[type="date"], input[type="number"], input[type="text"] {
            padding: 8px;
            border-radius: 8px;
            border: 1px solid #d1d5db;
            font-size: 0.9rem;
            min-width: 120px; /* Ensure date input has a default size */
            outline: none;
            transition: border-color 0.2s;
        }
        input[type="date"]:focus, input[type="number"]:focus, input[type="text"]:focus {
            border-color: #4c51bf;
        }
        /* Crucial for fixing date input width when flexed inside a TD's inner div */
        td .payment-date-input {
            flex-shrink: 0; /* Prevents the date input from shrinking */
        }
        /* Make sure the inner flex container does not add extra padding/margin to TD */
        td .flex-items-container {
            width: 100%; /* Ensure it fills the TD's width */
            display: flex; /* Apply flex to the inner container */
            align-items: center; /* Vertically align items */
            /* No padding here, padding is on the TD itself */
        }


        /* Status-specific background and text colors */
        .status-paid {
            background-color: #d1fae5; /* Green 100 */
            color: #065f46; /* Green 800 */
        }
        .status-not-paid {
            background-color: #fffacd; /* Yellow for "Not Paid (with interest)" */
            color: #b97d10; /* Darker yellow/orange */
        }
        .status-absent {
            background-color: #fee2e2; /* Red 100 */
            color: #991b1b; /* Red 800 */
        }
        .status-paid-late {
            background-color: #e0f2fe; /* Blue 100 */
            color: #1e40af; /* Blue 800 */
        }

        /* Utility classes for text and background */
        .text-green-800 { color: #065f46; }
        .bg-green-100 { background-color: #d1fae5; }
        .text-yellow-800 { color: #b97d10; }
        .bg-yellow-100 { background-color: #fffacd; }
        .text-red-800 { color: #991b1b; }
        .bg-red-100 { background-color: #fee2e2; }
        .text-blue-800 { color: #1e40af; }
        .bg-blue-100 { background-color: #e0f2fe; }

        .total-funds-box {
            background-color: #ecfdf5; /* Light green background */
            border: 2px solid #065f46; /* Green border */
            border-radius: 12px;
            padding: 20px;
            margin-top: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .total-funds-box h2 {
            font-size: 1.5rem;
            font-weight: 700;
            color: #065f46;
        }
        .total-funds-box span {
            font-size: 2rem;
            font-weight: 800;
            color: #065f46;
        }

        /* Styling for payment history section */
        .payment-history-section {
            margin-top: 40px;
            border-top: 1px solid #e5e7eb;
            padding-top: 30px;
        }
        .payment-history-section h2 {
            font-size: 2rem;
            font-weight: 700;
            color: #374151;
            margin-bottom: 20px;
            text-align: center;
        }
        .history-table {
            table-layout: fixed; /* Crucial for history table alignment */
        }
        .history-table th {
            background-color: #f7fafc; /* Lighter header for history */
            color: #4a5568;
        }
        /* Explicit column widths for history table */
        .history-table th:nth-child(1) { width: 25%; } /* Student Name */
        .history-table th:nth-child(2) { width: 10%; } /* Amount */
        .history-table th:nth-child(3) { width: 20%; } /* Status */
        .history-table th:nth-child(4) { width: 15%; } /* Payment Date */
        .history-table th:nth-child(5) { width: 20%; } /* Recorded At */
        .history-table th:nth-child(6) { width: 10%; } /* Actions */


        .history-table td {
            font-size: 0.875rem; /* Smaller text for history details */
        }
        /* Specific row styling for history for better readability */
        .history-table tr:nth-child(even) {
            background-color: #fcfcfc;
        }
        .history-table tr:nth-child(odd) {
            background-color: #ffffff;
        }
        /* History row status colors */
        .history-paid { background-color: #d1fae5; } /* Green 100 */
        .history-paid-late { background-color: #e0f2fe; } /* Blue 100 */
        .history-not-paid { background-color: #fffacd; } /* Yellow 100 */
        .history-absent { background-color: #fee2e2; } /* Red 100 */


        .delete-history-btn {
            background-color: #ef4444; /* Red 500 */
            color: white;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 0.75rem;
            cursor: pointer;
            border: none;
            transition: background-color 0.2s;
        }
        .delete-history-btn:hover {
            background-color: #dc2626; /* Red 600 */
        }
        .clear-all-history-btn {
            background-color: #f59e0b; /* Amber 500 */
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 0.9rem;
            cursor: pointer;
            border: none;
            transition: background-color 0.2s;
            margin-top: 20px;
            display: block;
            margin-left: auto;
            margin-right: auto;
        }
        .clear-all-history-btn:hover {
            background-color: #d97706; /* Amber 600 */
        }

        /* Minimalist Reset All button */
        .reset-all-btn {
            background-color: #e0e7ff; /* Light indigo */
            color: #4338ca; /* Darker indigo */
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 0.9rem;
            cursor: pointer;
            border: 1px solid #a5b4fc; /* Indigo 300 border */
            transition: background-color 0.2s, border-color 0.2s;
            margin-top: 20px;
            margin-bottom: 20px;
            display: block;
            margin-left: auto;
            margin-right: auto;
        }
        .reset-all-btn:hover {
            background-color: #c7d2fe; /* Indigo 200 */
            border-color: #818cf8; /* Indigo 400 */
        }

        /* Minimalist individual student reset button */
        .reset-student-btn {
            background-color: #f3f4f6; /* Gray 100 */
            color: #4b5563; /* Gray 600 */
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.65rem; /* Smaller font */
            cursor: pointer;
            border: 1px solid #d1d5db; /* Gray 300 border */
            transition: background-color 0.2s, border-color 0.2s;
            margin-left: 10px; /* Space from name */
            white-space: nowrap; /* Prevent text wrapping */
        }
        .reset-student-btn:hover {
            background-color: #e5e7eb; /* Gray 200 */
            border-color: #9ca3af; /* Gray 400 */
        }
        
        /* Apply Date to All button */
        .apply-date-to-all-btn {
            background-color: #22c55e; /* Green 500 */
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.8rem;
            cursor: pointer;
            border: none;
            transition: background-color 0.2s;
            margin-left: 10px; /* Space from date input */
            white-space: nowrap; /* Prevent text wrapping */
        }
        .apply-date-to-all-btn:hover {
            background-color: #16a34a; /* Green 600 */
        }

    </style>
</head>
<body class="p-4 sm:p-6 md:p-8">
    <div class="container">
        <h1 class="text-3xl font-extrabold text-gray-800 mb-6 text-center">12 STEM 2C - FUND TRACKER</h1>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
            <div class="flex items-center space-x-3">
                <label for="amountPerStudent" class="text-gray-700 font-medium whitespace-nowrap">Amount Per Student:</label>
                <input type="number" id="amountPerStudent" value="100.00" min="0" step="0.01"
                       class="flex-grow p-2 rounded-lg border border-gray-300 focus:ring-blue-500 focus:border-blue-500">
            </div>
            <div class="flex items-center space-x-3">
                <label for="trackingPeriod" class="text-gray-700 font-medium whitespace-nowrap">Tracking Period:</label>
                <input type="text" id="trackingPeriod" value="July 2025 Contributions"
                       class="flex-grow p-2 rounded-lg border border-gray-300 focus:ring-blue-500 focus:border-blue-500">
            </div>
        </div>

        <div class="total-funds-box">
            <h2>Total Funds Collected:</h2>
            <span id="totalFunds">₱0.00</span>
        </div>

        <button id="resetAllBtn" class="reset-all-btn">Reset All Statuses & Dates</button>

        <div class="overflow-x-auto mt-8">
            <table class="min-w-full">
                <thead>
                    <tr>
                        <th class="py-3 px-4 border-b-2 border-gray-200 bg-gray-100 text-left text-xs leading-4 font-semibold text-gray-600 uppercase tracking-wider rounded-tl-lg">Student Name</th>
                        <th class="py-3 px-4 border-b-2 border-gray-200 bg-gray-100 text-left text-xs leading-4 font-semibold text-gray-600 uppercase tracking-wider">Payment Date</th>
                        <th class="py-3 px-4 border-b-2 border-gray-200 bg-gray-100 text-left text-xs leading-4 font-semibold text-gray-600 uppercase tracking-wider rounded-tr-lg">Status</th>
                    </tr>
                </thead>
                <tbody id="studentTableBody">
                    </tbody>
            </table>
        </div>

        <div class="payment-history-section">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">Payment History</h2>
            <button id="clearAllHistoryBtn" class="clear-all-history-btn">Clear All History for Current Period</button>
            <div class="overflow-x-auto mt-4">
                <table class="min-w-full history-table">
                    <thead>
                        <tr>
                            <th class="py-3 px-4 border-b-2 border-gray-200 bg-gray-100 text-left text-xs leading-4 font-semibold text-gray-600 uppercase tracking-wider rounded-tl-lg">Student Name</th>
                            <th class="py-3 px-4 border-b-2 border-gray-200 bg-gray-100 text-left text-xs leading-4 font-semibold text-gray-600 uppercase tracking-wider">Amount</th>
                            <th class="py-3 px-4 border-b-2 border-gray-200 bg-gray-100 text-left text-xs leading-4 font-semibold text-gray-600 uppercase tracking-wider">Status</th>
                            <th class="py-3 px-4 border-b-2 border-gray-200 bg-gray-100 text-left text-xs leading-4 font-semibold text-gray-600 uppercase tracking-wider">Payment Date</th>
                            <th class="py-3 px-4 border-b-2 border-gray-200 bg-gray-100 text-left text-xs leading-4 font-semibold text-gray-600 uppercase tracking-wider">Recorded At</th>
                            <th class="py-3 px-4 border-b-2 border-gray-200 bg-gray-100 text-left text-xs leading-4 font-semibold text-gray-600 uppercase tracking-wider rounded-tr-lg">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="paymentHistoryBody">
                        </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // --- Constants and Global Variables ---
        const studentTableBody = document.getElementById('studentTableBody');
        const amountPerStudentInput = document.getElementById('amountPerStudent');
        const trackingPeriodInput = document.getElementById('trackingPeriod');
        const totalFundsDisplay = document.getElementById('totalFunds');
        const paymentHistoryBody = document.getElementById('paymentHistoryBody');
        const clearAllHistoryBtn = document.getElementById('clearAllHistoryBtn');
        const resetAllBtn = document.getElementById('resetAllBtn');
        const latePaymentInterest = 1.00;

        const studentNames = [
            "Andales, Krizzia Alexa", "Bangay, Chandy", "Binondo, Irish Kiara", "Ceasar, Schynia Lanelle", "Carbajosa, Fatima Winselth", "Cristobal, Abejah Caila", "Fuertes, Shenna", "Inopiquez, Fiona Clarice",
            "Labod, Jezzaira", "Media, Jasmine Florence", "Nazareno, Miannel", "Plaza, Aleana Rose Klariza", "Ranile, Apple", "Sambu, Rhian Marie", "Tangaja, Mary Flor ", "Ablan, Laurence Zachary",
            "Ablen, Rhys", "Apawan, Rasheed Kyle", "Armenion, Justin Cody", "Asentista, Paul James", "Bernante, Francis Xavier Martin", "Cabilao, John Kenneth", "Cale, Donneil", "Carmelotes, Cris James",
            "Cortes, Marion Rae", "Esgana, Jomiel Augustine", "Esique, Vincent Kenneth", "Hortelano, Gian Carlo", "Llenes, Jack Ryan", "Loyola, Rinz Albert", "Maloloy-on, Artmeighen", "Mansueto, Joshua",
            "Montes, Vinshee Luis", "Morales, Jaredd Wulther", "Pepito, John Marco", "Remolano, John Michael", "Zabate, Ziann Alexander"
        ];
        const numberOfStudents = studentNames.length;

        // Data arrays - these will be loaded from localStorage or initialized
        let students = [];
        let paymentHistory = [];

        // --- Local Storage Keys ---
        const LOCAL_STORAGE_STUDENTS_KEY = 'stem2c_students';
        const LOCAL_STORAGE_HISTORY_KEY = 'stem2c_payment_history';
        const LOCAL_STORAGE_AMOUNT_KEY = 'stem2c_amount_per_student';
        const LOCAL_STORAGE_PERIOD_KEY = 'stem2c_tracking_period';


        // --- Data Management Functions (Load, Save, Initialize) ---

        /**
         * Loads data from localStorage.
         */
        function loadData() {
            const savedStudents = localStorage.getItem(LOCAL_STORAGE_STUDENTS_KEY);
            const savedHistory = localStorage.getItem(LOCAL_STORAGE_HISTORY_KEY);
            const savedAmount = localStorage.getItem(LOCAL_STORAGE_AMOUNT_KEY);
            const savedPeriod = localStorage.getItem(LOCAL_STORAGE_PERIOD_KEY);

            if (savedStudents) {
                students = JSON.parse(savedStudents);
            } else {
                initializeStudents();
            }

            if (savedHistory) {
                paymentHistory = JSON.parse(savedHistory);
            } else {
                paymentHistory = [];
            }

            if (savedAmount) {
                amountPerStudentInput.value = parseFloat(savedAmount).toFixed(2);
            }
            if (savedPeriod) {
                trackingPeriodInput.value = savedPeriod;
            }
        }

        /**
         * Saves current data to localStorage.
         */
        function saveData() {
            localStorage.setItem(LOCAL_STORAGE_STUDENTS_KEY, JSON.stringify(students));
            localStorage.setItem(LOCAL_STORAGE_HISTORY_KEY, JSON.stringify(paymentHistory));
            localStorage.setItem(LOCAL_STORAGE_AMOUNT_KEY, amountPerStudentInput.value);
            localStorage.setItem(LOCAL_STORAGE_PERIOD_KEY, trackingPeriodInput.value);
        }

        /**
         * Initializes the 'students' array with default data.
         * Called only if no saved student data is found in localStorage.
         */
        function initializeStudents() {
            students = [];
            for (let i = 0; i < numberOfStudents; i++) {
                students.push({
                    id: i + 1,
                    name: studentNames[i],
                    status: 'not-paid',
                    paymentDate: ''
                });
            }
            saveData();
        }


        // --- Core Application Logic ---

        /**
         * Initializes the tracker by loading data and rendering tables.
         */
        function initializeTracker() {
            loadData();
            renderTable();
            calculateTotalFunds();
            renderPaymentHistory();
            addInitialEventListeners();
        }

        /**
         * Renders or re-renders the main student table based on the 'students' array.
         */
        function renderTable() {
            studentTableBody.innerHTML = '';
            students.forEach((student, index) => {
                // The TD itself does NOT have flex anymore. Its inner content will.
                const studentNameCellContent = `
                    <div class="flex items-center">
                        ${student.name}
                        <button class="reset-student-btn" data-student-id="${student.id}">Reset</button>
                    </div>
                `;

                let paymentDateCellContent = `
                    <div class="flex items-center">
                        <input type="date" value="${student.paymentDate}" data-student-id="${student.id}" class="payment-date-input">
                `;
                // Add "Apply to All" button only to the first student's date input
                if (index === 0) {
                    const displayStyle = student.paymentDate ? 'flex' : 'none'; // Initially show if date is set
                    paymentDateCellContent += `
                        <div id="applyDateContainer" style="display: ${displayStyle}; align-items: center;">
                            <button class="apply-date-to-all-btn" id="applyDateToAllBtn">Apply to All</button>
                        </div>
                    `;
                }
                paymentDateCellContent += `</div>`; // Close the flex div for payment date

                const row = document.createElement('tr');
                row.className = `transition duration-150 ease-in-out ${getStatusClass(student.status)}`;

                row.innerHTML = `
                    <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">
                        ${studentNameCellContent}
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700">
                        ${paymentDateCellContent}
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700">
                        <select data-student-id="${student.id}" class="status-select">
                            <option value="paid" ${student.status === 'paid' ? 'selected' : ''} class="text-green-800">Paid</option>
                            <option value="paid-late" ${student.status === 'paid-late' ? 'selected' : ''} class="text-blue-800">Paid (late)</option>
                            <option value="not-paid" ${student.status === 'not-paid' ? 'selected' : ''} class="text-yellow-800">Not Paid (with interest)</option>
                            <option value="absent" ${student.status === 'absent' ? 'selected' : ''} class="text-red-800">Absent</option>
                        </select>
                    </td>
                `;
                studentTableBody.appendChild(row);
            });
            addDynamicEventListeners();
        }

        /**
         * Attaches event listeners to the dynamically created status select, date input,
         * and the new individual reset buttons. Also for the new "Apply Date to All" button.
         */
        function addDynamicEventListeners() {
            document.querySelectorAll('.status-select').forEach(selectElement => {
                selectElement.onchange = (event) => {
                    const studentId = parseInt(event.target.dataset.studentId);
                    const newStatus = event.target.value;
                    updateStudentStatus(studentId, newStatus);
                };
            });

            document.querySelectorAll('.payment-date-input').forEach((dateInputElement, index) => {
                // Add general date change listener for all date inputs
                dateInputElement.onchange = (event) => {
                    const studentId = parseInt(event.target.dataset.studentId);
                    const newDate = event.target.value;
                    updateStudentDate(studentId, newDate);
                    const student = students.find(s => s.id === studentId);
                    // Only log to history if student is in a paid state and date changes
                    if (student && (student.status === 'paid' || student.status === 'paid-late')) {
                        logStudentStatusChange(student);
                    }
                };

                // Add specific listener for the first date input to control button visibility
                if (index === 0) {
                    dateInputElement.addEventListener('input', toggleApplyDateButtonVisibility);
                }
            });

            document.querySelectorAll('.reset-student-btn').forEach(button => {
                button.addEventListener('click', (event) => {
                    const studentId = parseInt(event.target.dataset.studentId);
                    resetIndividualStudent(studentId);
                });
            });

            // New: Event listener for the "Apply Date to All" button
            const applyDateToAllBtn = document.getElementById('applyDateToAllBtn');
            if (applyDateToAllBtn) {
                applyDateToAllBtn.addEventListener('click', applyDateToAll);
            }
        }

        /**
         * Toggles the visibility of the "Apply Date to All" button based on the
         * value of the first student's payment date input.
         */
        function toggleApplyDateButtonVisibility() {
            const firstDateInput = document.querySelector('.payment-date-input');
            const applyDateContainer = document.getElementById('applyDateContainer');
            if (firstDateInput && applyDateContainer) {
                if (firstDateInput.value) {
                    applyDateContainer.style.display = 'flex';
                } else {
                    applyDateContainer.style.display = 'none';
                }
            }
        }


        /**
         * Attaches event listeners to the static input fields (amount per student, tracking period)
         * and the "Clear All History" and "Reset All" buttons.
         */
        function addInitialEventListeners() {
            amountPerStudentInput.addEventListener('input', () => {
                calculateTotalFunds();
                saveData();
                renderPaymentHistory();
            });
            trackingPeriodInput.addEventListener('input', () => {
                saveData();
                renderPaymentHistory();
            });

            clearAllHistoryBtn.addEventListener('click', clearCurrentPeriodHistory);
            resetAllBtn.addEventListener('click', resetAllStudents);
        }

        /**
         * Updates a student's status and triggers recalculation/history logging if necessary.
         * @param {number} id - The ID of the student to update.
         * @param {string} newStatus - The new status to set for the student.
         */
        function updateStudentStatus(id, newStatus) {
            const studentIndex = students.findIndex(s => s.id === id);
            if (studentIndex !== -1) {
                students[studentIndex].status = newStatus;
                const student = students[studentIndex];

                // Log every status change to history
                logStudentStatusChange(student);

                const row = studentTableBody.children[studentIndex];
                row.classList.remove('status-paid', 'status-not-paid', 'status-absent', 'status-paid-late');
                row.classList.add(getStatusClass(newStatus));

                calculateTotalFunds(); // This is where total funds are correctly updated
                saveData();
            }
        }

        /**
         * Resets the status and payment date for a single student in the main table.
         * Does NOT affect payment history or total funds.
         * @param {number} id - The ID of the student to reset.
         */
        function resetIndividualStudent(id) {
            const studentIndex = students.findIndex(s => s.id === id);
            if (studentIndex !== -1) {
                if (confirm(`Are you sure you want to reset ${students[studentIndex].name}'s status and payment date to 'Not Paid'? This will NOT affect total funds or payment history.`)) {
                    students[studentIndex].status = 'not-paid';
                    students[studentIndex].paymentDate = '';

                    renderTable(); // Re-render to show individual student's reset
                    saveData();
                    alert(`${students[studentIndex].name}'s status and date reset.`);
                }
            }
        }

        /**
         * Resets the status and payment date for all students in the main table.
         * Does NOT affect payment history or total funds.
         */
        function resetAllStudents() {
            if (confirm("Are you sure you want to reset ALL student statuses and payment dates to 'Not Paid'? This will NOT affect total funds or payment history entries.")) {
                students.forEach(student => {
                    student.status = 'not-paid';
                    student.paymentDate = '';
                });
                renderTable();
                saveData();
                alert("All student statuses and dates reset in the main table.");
            }
        }

        /**
         * Applies the date from the first student's input field to all students.
         * Does NOT affect payment history or total funds, but will trigger history
         * updates for already 'paid' students whose dates change.
         */
        function applyDateToAll() {
            const firstDateInput = document.querySelector('.payment-date-input');
            const dateToApply = firstDateInput ? firstDateInput.value : '';

            if (!dateToApply) {
                alert("Please select a date in the first student's date field before using 'Apply to All'.");
                return;
            }

            if (confirm(`Are you sure you want to apply the date ${dateToApply} to ALL students? This will NOT change their payment status.`)) {
                students.forEach(student => {
                    const oldDate = student.paymentDate;
                    student.paymentDate = dateToApply;

                    // If a student was already paid, and their date changes, log this to history
                    if ((student.status === 'paid' || student.status === 'paid-late') && oldDate !== dateToApply) {
                        logStudentStatusChange(student); // This will update the existing history entry
                    }
                });
                renderTable(); // Re-render to show updated dates
                saveData();
                alert(`Date ${dateToApply} applied to all students.`);
            }
        }

        /**
         * Updates a student's payment date.
         * @param {number} id - The ID of the student to update.
         * @param {string} newDate - The new date string to set.
         */
        function updateStudentDate(id, newDate) {
            const studentIndex = students.findIndex(s => s.id === id);
            if (studentIndex !== -1) {
                students[studentIndex].paymentDate = newDate;
                saveData();
            }
        }

        /**
         * Returns the appropriate CSS class based on the payment status.
         * @param {string} status - The payment status ('paid', 'not-paid', 'absent', 'paid-late').
         * @returns {string} The CSS class name.
         */
        function getStatusClass(status) {
            switch (status) {
                case 'paid':
                    return 'status-paid';
                case 'not-paid':
                    return 'status-not-paid';
                case 'absent':
                    return 'status-absent';
                case 'paid-late':
                    return 'status-paid-late';
                default:
                    return '';
            }
        }

        /**
         * Calculates and displays the total funds collected based on students with 'paid' or 'paid-late' status.
         */
        function calculateTotalFunds() {
            const amountPerStudent = parseFloat(amountPerStudentInput.value);
            let totalCollected = 0;

            if (isNaN(amountPerStudent) || amountPerStudent < 0) {
                totalFundsDisplay.textContent = '₱0.00';
                return;
            }

            students.forEach(student => {
                if (student.status === 'paid') {
                    totalCollected += amountPerStudent;
                } else if (student.status === 'paid-late') {
                    totalCollected += (amountPerStudent + latePaymentInterest);
                }
            });

            totalFundsDisplay.textContent = `₱${totalCollected.toFixed(2)}`;
        }

        /**
         * Logs a student's status change to the payment history array.
         * This function logs ALL status changes, not just paid ones.
         * It updates an existing entry or adds a new one.
         * @param {object} student - The student object for whom the status changed.
         */
        function logStudentStatusChange(student) {
            const amountPerStudent = parseFloat(amountPerStudentInput.value);
            let collectedAmount = 0;
            let statusDisplayText = '';

            switch (student.status) {
                case 'paid':
                    collectedAmount = amountPerStudent;
                    statusDisplayText = 'Paid';
                    break;
                case 'paid-late':
                    collectedAmount = amountPerStudent + latePaymentInterest;
                    statusDisplayText = 'Paid (late)';
                    break;
                case 'not-paid':
                    collectedAmount = amountPerStudent + latePaymentInterest; // Still shows the potential amount + interest for context
                    statusDisplayText = 'Not Paid (with interest)';
                    break;
                case 'absent':
                    collectedAmount = 0; // Absent means no payment due for that event
                    statusDisplayText = 'Absent';
                    break;
            }

            const paymentDate = student.paymentDate || 'N/A';
            const uniqueRecordedAt = new Date().toISOString() + "_" + Math.random().toString(36).substring(2, 8);

            const newEntry = {
                studentName: student.name,
                amount: collectedAmount,
                status: statusDisplayText,
                rawStatus: student.status, // Store the raw status for conditional styling
                date: paymentDate,
                recordedAt: uniqueRecordedAt,
                trackingPeriod: trackingPeriodInput.value
            };

            // Remove any *previous* entry for this student within the *current tracking period*
            // before adding the new one, to ensure only the latest status for a given period is shown.
            // This effectively "updates" the history for that student in that period.
            paymentHistory = paymentHistory.filter(entry =>
                !(entry.studentName === student.name && entry.trackingPeriod === trackingPeriodInput.value)
            );

            // Add the new status change to history
            paymentHistory.push(newEntry);

            renderPaymentHistory();
            saveData();
        }

        /**
         * Removes a specific history entry based on its unique 'recordedAt' timestamp.
         * @param {string} recordedAtIdentifier - The unique identifier of the history entry.
         */
        function deleteHistoryEntry(recordedAtIdentifier) {
            paymentHistory = paymentHistory.filter(entry => entry.recordedAt !== recordedAtIdentifier);
            renderPaymentHistory();
            saveData();
        }

        /**
         * Clears all payment history entries for the currently selected tracking period.
         */
        function clearCurrentPeriodHistory() {
            if (confirm(`Are you sure you want to clear ALL payment history for "${trackingPeriodInput.value}"? This action cannot be undone.`)) {
                paymentHistory = paymentHistory.filter(entry => entry.trackingPeriod !== trackingPeriodInput.value);
                renderPaymentHistory();
                saveData();
                alert(`All payment history for "${trackingPeriodInput.value}" has been cleared.`);
            }
        }


        /**
         * Renders or re-renders the payment history table based on the 'paymentHistory' array.
         */
        function renderPaymentHistory() {
            paymentHistoryBody.innerHTML = '';

            // Filter history entries by the current tracking period and then sort
            const filteredAndSortedHistory = paymentHistory
                .filter(entry => entry.trackingPeriod === trackingPeriodInput.value)
                .sort((a, b) => new Date(b.recordedAt.split('_')[0]) - new Date(a.recordedAt.split('_')[0]));

            if (filteredAndSortedHistory.length === 0) {
                paymentHistoryBody.innerHTML = `<tr><td colspan="6" class="text-center py-4 text-gray-500">No payment history yet for this period. Update a student's status to record entries.</td></tr>`;
                return;
            }

            filteredAndSortedHistory.forEach(entry => {
                const row = document.createElement('tr');
                // Use rawStatus for consistent background coloring in history
                row.className = `border-b border-gray-200 history-${entry.rawStatus}`;

                row.innerHTML = `
                    <td class="px-4 py-2 whitespace-nowrap text-sm font-medium text-gray-900">${entry.studentName}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700">₱${entry.amount.toFixed(2)}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700">${entry.status}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700">${entry.date}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500 text-xs">${new Date(entry.recordedAt.split('_')[0]).toLocaleString()}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-700">
                        <button class="delete-history-btn" data-recorded-at="${entry.recordedAt}">Delete</button>
                    </td>
                `;
                paymentHistoryBody.appendChild(row);
            });

            // Attach event listeners to the new delete buttons
            document.querySelectorAll('.delete-history-btn').forEach(button => {
                button.addEventListener('click', (event) => {
                    const recordedAt = event.target.dataset.recordedAt;
                    if (confirm("Are you sure you want to delete this payment history entry?")) {
                        deleteHistoryEntry(recordedAt);
                    }
                });
            });
        }


        // --- Initialization ---
        window.onload = initializeTracker;
    </script>
</body>
</html>
